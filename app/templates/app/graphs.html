{% extends "app/layout.html" %}

{% block content %}

<div class="page-header">
    <h2>Cost Comparison Graphs</h2>
    <p class="text-muted">Compare your actual electricity costs (including VAT + transfer costs) with what fixed pricing would have cost over the same period.</p>
</div>

<div class="row">
    <div class="col-md-12">
        <!-- Input Controls -->
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Comparison Parameters</h3>
            </div>
            <div class="panel-body">
                <form id="graphForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="fixedPrice" class="col-sm-3 control-label">Fixed Price (c/kWh):</label>
                        <div class="col-sm-3">
                            <input type="number" 
                                   class="form-control" 
                                   id="fixedPrice" 
                                   name="fixed_price" 
                                   value="{{ fixed_price }}" 
                                   step="0.1" 
                                   min="0" 
                                   max="50">
                        </div>
                        <div class="col-sm-6">
                            <p class="form-control-static text-muted">
                                <small>Total price including VAT and transfer costs</small>
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="yearlyConsumption" class="col-sm-3 control-label">Total Yearly Consumption (kWh):</label>
                        <div class="col-sm-3">
                            <input type="number" 
                                   class="form-control" 
                                   id="yearlyConsumption" 
                                   name="yearly_consumption" 
                                   value="{{ yearly_consumption }}" 
                                   min="1" 
                                   max="100000"
                                   oninput="calculateWatts()">
                        </div>
                        <div class="col-sm-6">
                            <p class="form-control-static text-muted">
                                <small>Enter your total yearly electricity consumption</small>
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="watts" class="col-sm-3 control-label">Power Consumption (W):</label>
                        <div class="col-sm-3">
                            <input type="number" 
                                   class="form-control" 
                                   id="watts" 
                                   name="watts" 
                                   value="{{ watts }}" 
                                   min="1" 
                                   max="10000"
                                   readonly
                                   style="background-color: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="col-sm-6">
                            <p class="form-control-static text-muted">
                                <small>Calculated: (Yearly kWh × 1000) ÷ 8760 hours</small>
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="shellyControlledPercentage" class="col-sm-3 control-label">Shelly Controlled Usage (%):</label>
                        <div class="col-sm-3">
                            <input type="number" 
                                   class="form-control" 
                                   id="shellyControlledPercentage" 
                                   name="shelly_controlled_percentage" 
                                   value="{{ shelly_controlled_percentage }}" 
                                   min="1" 
                                   max="100"
                                   step="1">
                        </div>
                        <div class="col-sm-6">
                            <p class="form-control-static text-muted">
                                <small>What % of your total consumption does Shelly control? (Water heater + floor heating)</small>
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-6">
                            <button type="submit" class="btn btn-primary">Update Graph</button>
                            <span id="loadingIndicator" class="text-muted" style="display: none;">
                                <i class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></i> Loading...
                            </span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Graph Container -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Total Cost Comparison Over Time (incl. VAT + Transfer Costs)</h3>
            </div>
            <div class="panel-body">
                <canvas id="costChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 30px;">
    <div class="col-md-12">
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">Temperature Overview</h3>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label for="thermostatSelect">Select Thermostat:</label>
                    <select id="thermostatSelect" class="form-control" onchange="updateThermostatSelection()">
                        {% for thermostat in thermostat_devices %}
                            <option value="{{ thermostat.device_id }}" {% if selected_thermostat and thermostat.device_id == selected_thermostat.device_id %}selected{% endif %}>
                                {{ thermostat.familiar_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Last 15 Days</h3>
                    </div>
                    <div class="panel-body">
                        <canvas id="temperatureChart" height="300"></canvas>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Yearly Overview</h3>
                    </div>
                    <div class="panel-body">
                        <canvas id="temperatureYearChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let chart = null;
    let graphData = {{ graph_data|safe }};
    let temperatureGraphData = {{ temperature_graph_data|safe }};
    let temperatureYearGraphData = {{ temperature_year_graph_data|safe }};

    function calculateWatts() {
        const yearlyConsumption = parseFloat(document.getElementById('yearlyConsumption').value) || 0;
        // Convert yearly kWh to average watts: (kWh * 1000) / 8760 hours
        const watts = Math.round((yearlyConsumption * 1000) / 8760);
        document.getElementById('watts').value = watts;
    }

    function updateUserSelection() {
        const userId = document.getElementById('userSelect').value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('user_id', userId);
        window.location.href = currentUrl.toString();
    }

    function updateThermostatSelection() {
        const thermostatSelect = document.getElementById('thermostatSelect');
        const currentUrl = new URL(window.location.href);
        if (thermostatSelect && thermostatSelect.value) {
            currentUrl.searchParams.set('thermostat_device_id', thermostatSelect.value);
        } else {
            currentUrl.searchParams.delete('thermostat_device_id');
        }
        window.location.href = currentUrl.toString();
    }

    function updateChart(data) {
        console.log('updateChart called with:', data);
        
        const canvas = document.getElementById('costChart');
        if (!canvas) {
            console.error('Canvas element not found');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Could not get canvas context');
            return;
        }
        
        // Destroy existing chart if it exists
        if (chart) {
            chart.destroy();
        }
        
        // Create new chart
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Dynamic Pricing (€' + data.total_dynamic.toFixed(2) + ' total)',
                        data: data.dynamic_costs,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: 'rgb(40, 167, 69)',
                        pointBorderColor: 'rgb(40, 167, 69)',
                        pointRadius: 1.5,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    },
                    {
                        label: 'Fixed Pricing (€' + data.total_fixed.toFixed(2) + ' total) - ' + data.fixed_price + 'c/kWh',
                        data: data.fixed_costs,
                        borderColor: 'rgb(23, 162, 184)',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: 'rgb(23, 162, 184)',
                        pointBorderColor: 'rgb(23, 162, 184)',
                        pointRadius: 1.5,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 13
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: [
                            'Total Electricity Costs (VAT + Transfer Included) - Savings: €' + Math.abs(data.savings).toFixed(2) + ' (' + Math.abs(data.savings_percentage).toFixed(1) + '%)',
                            'Avg Dynamic Price: ' + data.avg_dynamic_price.toFixed(2) + ' c/kWh (incl. VAT & Transfer)'
                        ],
                        font: {
                            size: 14
                        },
                        padding: {
                            bottom: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                if (context.length > 0) {
                                    const dataIndex = context[0].dataIndex;
                                    const priceInfo = graphData.period_prices[dataIndex];
                                    
                                    if (!priceInfo) return [];
                                    
                                    const lines = [''];
                                    
                                    if (priceInfo.has_usage) {
                                        lines.push('Base Price: ' + priceInfo.base_price.toFixed(2) + ' c/kWh');
                                        lines.push('Transfer Cost: ' + priceInfo.transfer.toFixed(2) + ' c/kWh');
                                        lines.push('Dynamic Price (incl. VAT): ' + priceInfo.dynamic.toFixed(2) + ' c/kWh');
                                        lines.push('Fixed Price (incl. VAT): ' + priceInfo.fixed.toFixed(2) + ' c/kWh');
                                        
                                        if (context.length > 1) {
                                            const dynamic = context[0].parsed.y;
                                            const fixed = context[1].parsed.y;
                                            const diff = fixed - dynamic;
                                            lines.push('');
                                            lines.push('Cumulative Difference: €' + diff.toFixed(2));
                                        }
                                    } else {
                                        lines.push('No device usage during this period');
                                        lines.push('Base Price: ' + priceInfo.base_price.toFixed(2) + ' c/kWh');
                                    }
                                    
                                    return lines;
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time Period (15-minute intervals)'
                        },
                        ticks: {
                            maxTicksLimit: 96,  // Show up to 96 ticks (24 hours × 4 periods)
                            maxRotation: 90,
                            minRotation: 45,
                            autoSkip: true,
                            autoSkipPadding: 10
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Cumulative Cost (€)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return '€' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    let tempChart = null;
    let tempYearChart = null;

    function updateTemperatureCharts() {
        const tempCanvas = document.getElementById('temperatureChart');
        if (!tempCanvas) {
            return;
        }
        const tempCtx = tempCanvas.getContext('2d');
        if (tempChart) {
            tempChart.destroy();
        }
        tempChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: temperatureGraphData.labels,
                datasets: [
                    {
                        label: 'Temperature (C)',
                        data: temperatureGraphData.values,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 2,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'C'
                        }
                    }
                }
            }
        });

        const yearCanvas = document.getElementById('temperatureYearChart');
        if (!yearCanvas) {
            return;
        }
        const yearCtx = yearCanvas.getContext('2d');
        if (tempYearChart) {
            tempYearChart.destroy();
        }
        tempYearChart = new Chart(yearCtx, {
            type: 'bar',
            data: {
                labels: temperatureYearGraphData.labels,
                datasets: [
                    {
                        label: 'Average Temperature (C)',
                        data: temperatureYearGraphData.values,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'C'
                        }
                    }
                }
            }
        });
    }

    // Initialize chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate initial watts value from yearly consumption
        calculateWatts();
        
        if (graphData && graphData.labels && graphData.labels.length > 0) {
            updateChart(graphData);
        } else {
            // Show a message to the user
            const ctx = document.querySelector('#costChart').getContext('2d');
            ctx.font = "16px Arial";
            ctx.fillText("No data available. Please check if you have electricity price data in the database.", 10, 50);
        }
        updateTemperatureCharts();
    });

    // Handle form submission
    document.getElementById('graphForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'inline';
        
        // Disable the submit button to prevent double-clicks
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Updating...';
        
        // Make AJAX request
        const urlParams = new URLSearchParams(formData);
        urlParams.append('_t', Date.now()); // Add cache buster
        
        // Add user_id if present (for admin viewing other users)
        const userSelect = document.getElementById('userSelect');
        if (userSelect) {
            urlParams.append('user_id', userSelect.value);
        }
        
        fetch('/shellyapp/get-graph-data/?' + urlParams.toString())
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Server returned error:', data.error);
                    alert('Error: ' + data.error);
                } else if (data.graph_data) {
                    updateChart(data.graph_data);
                } else {
                    console.error('No graph_data found in response:', data);
                    alert('Invalid response format from server');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the graph: ' + error.message);
            })
            .finally(() => {
                // Hide loading indicator and restore button
                document.getElementById('loadingIndicator').style.display = 'none';
                const submitButton = document.querySelector('#graphForm button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Graph';
            });
    });
</script>

<style>
    .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
    }

    @-webkit-keyframes spin2 {
        from { -webkit-transform: rotate(0deg);}
        to { -webkit-transform: rotate(360deg);}
    }

    @keyframes spin {
        from { transform: scale(1) rotate(0deg);}
        to { transform: scale(1) rotate(360deg);}
    }

    #costChart {
        height: 400px !important;
    }
</style>

{% endblock %}
